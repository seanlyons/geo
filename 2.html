<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title></title>
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src-data='https://github.com/carhartl/jquery-cookie/blob/master/src/jquery.cookie.js' src='https://rawgit.com/carhartl/jquery-cookie/master/src/jquery.cookie.js'></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    .map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>
<body>
<div id='map-one' class='map'> </div>
<script>
var neighborhoods_layer;
var neighborhoods_count = -1;
var map;
var geojson;
var L;
var x = 37.729223;
var y = -122.444564;

function rand_str(len) {
    len = (len || 29);
    
    alphanum = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    now = Math.floor((new Date).getTime() / 1000);
    //console.log(now);
    str = '';
    for (i = 0; i <= len; i++) {
        str += alphanum[Math.floor((Math.random() * alphanum.length) + 1)];
    }
    str += '_' + now;
    console.log(str);
}
rand_str();

function initialize(self_coords) {
    L.mapbox.accessToken = 'pk.eyJ1IjoiZHVlbmRlIiwiYSI6Ijk0NDg5NTU2M2Q3OGU2ZmZhMWNjYzg3MjMyOWM1YmVlIn0.dKQrnkU5ALH3ezZ9pZ4Yeg';
    sf_coords = [37.765,-122.44];
    map = L.mapbox.map('map-one', 'mapbox.streets').setView(sf_coords, 13);
	
	neighborhoods_layer = L.geoJson(geojson, {
        fillColor: '#444',
        weight: 1
    }).addTo(map);
    
	$.getJSON("sf.json", function(json) {
        pretty = JSON.stringify(json, null, 4);
        var i = 0;
        feature = [];
        $.each(json['features'], function() {
            i++;
            if (this) {
                ent = this;
                ent.id = i;
                feature.push(ent);
            }
            return true;
        });
        json.features = feature;
        neighborhoods_layer.addData(json);
        console.log(neighborhoods_layer);
	});
	
	//console.log('map!');
	i = 0;
	map.eachLayer(function(layer) {
		i++;
	});
	//console.log(i);
}

function get_location() {
    navigator.geolocation.getCurrentPosition(obtain_x_y);
}

function obtain_x_y(position) {
	x = position.coords.latitude;
	y = position.coords.longitude;
	L.marker([x, y]).addTo(map);
}

function toggle_neighborhood_color(layer) {
	off = '#444';
	on = '#f00';
	if (!layer.options.fillColor
	|| !layer.options
	|| !layer.options.fillColor) {
		//console.log('No layer.options.fillColor found!');
		return;
	} else {
		//console.log('layer.options.fillColor = ' + layer.options.fillColor);
	}
	if (layer.options.fillColor == off) {
		layer.setStyle({color:on, fillColor:on});
	} else {
		layer.setStyle({color:off, fillColor:off});
	}
}

function in_neighborhood(x_y, callback_name) {
	map.eachLayer(function(layer) {
		//console.log(layer);
		callback_name(layer);
	});
}

function locate_neighborhood(arg) {
	//console.log("FNORD! " + arg);
}

get_location();
initialize([x, y]);
in_neighborhood([x, y], locate_neighborhood);

neighborhoods_layer.on('click', function(e) {
	//console.log('x,y = ', x, y);
    neighborhood_name = e.layer.feature.properties.name;
    map.eachLayer(function(layer) {
        feature = layer['feature'];

        if (feature
        && feature.properties
        && feature.properties.name
        && neighborhood_name == feature.properties.name) {
            toggle_neighborhood_color(layer);
			//console.log('layer');
			console.log(neighborhood_name+'!');
			console.log(feature.properties);
        }
    });
});
</script>
</body>
</html>